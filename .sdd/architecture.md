# システムアーキテクチャ

## 全体構成図

```
┌─────────────────────────────────┐
│  React Frontend (TypeScript)    │
│  - ゲームUI                     │
│  - WebSocketクライアント        │
│  - ルーム管理画面               │
└────────────┬────────────────────┘
             │ WebSocket (WSS)
             │ HTTP/HTTPS (REST API)
             ▼
┌─────────────────────────────────┐
│  Gin Server (Go)                │
│  - WebSocketハンドラー          │
│  - ルーム管理API                │
│  - ゲーム状態管理               │
│  - 並行処理によるコネクション管理│
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  Redis                          │
│  - ルーム情報 (room:*)          │
│  - 盤面状態 (board:*)           │
│  - プレイヤー情報 (player:*)    │
│  - TTL設定（自動削除）          │
└─────────────────────────────────┘
```

## 通信フロー

### ルーム作成フロー

```
Client                    Server                    Redis
  │                          │                        │
  │─── POST /api/rooms ─────>│                        │
  │                          │─── SET room:{id} ────>│
  │                          │<── OK ────────────────│
  │<── { roomId } ──────────│                        │
  │                          │                        │
  │─── WS Connect ─────────>│                        │
  │<── ROOM_CREATED ────────│                        │
```

### ゲームプレイフロー

```
Client A                  Server                  Client B
  │                          │                        │
  │─── CELL_TOGGLE ────────>│                        │
  │                          │─── Update Redis ─────>│
  │                          │                        │
  │<── BOARD_UPDATE ────────│─── BOARD_UPDATE ─────>│
  │                          │                        │
```

## レイヤー構成

### フロントエンド

```
┌──────────────────────────────────────────┐
│              Presentation Layer           │
│   (React Components: Board, Cell, etc.)   │
├──────────────────────────────────────────┤
│              State Management             │
│   (Redux Toolkit: gameSlice)              │
├──────────────────────────────────────────┤
│              Service Layer                │
│   (WebSocket Client, API Client)          │
├──────────────────────────────────────────┤
│              Type Definitions             │
│   (TypeScript Interfaces)                 │
└──────────────────────────────────────────┘
```

### バックエンド

```
┌──────────────────────────────────────────┐
│              Handler Layer                │
│   (HTTP Handlers, WebSocket Handlers)     │
├──────────────────────────────────────────┤
│              Service Layer                │
│   (Game Logic, Room Management)           │
├──────────────────────────────────────────┤
│              Data Access Layer            │
│   (Redis Client)                          │
├──────────────────────────────────────────┤
│              Model Layer                  │
│   (Game State, Room, Player)              │
└──────────────────────────────────────────┘
```

## データフロー

### 状態同期の仕組み

1. **ローカル更新**: ユーザーがセルをクリック → Redux storeを即座に更新（楽観的更新）
2. **サーバー送信**: WebSocket経由でCELL_TOGGLEメッセージを送信
3. **サーバー処理**: Goサーバーが状態を検証・保存（Redis）
4. **ブロードキャスト**: 同じルームの全クライアントにBOARD_UPDATEを送信
5. **状態同期**: 各クライアントがRedux storeを更新

## セキュリティ考慮事項

- **CORS設定**: 許可されたオリジンのみ接続可能
- **入力バリデーション**: 座標範囲チェック (0-7)
- **レート制限**: 過度なリクエストの防止
- **WebSocket認証**: ルームIDによる簡易認証（将来的に強化可能）

## スケーラビリティ

### 現在の設計（単一サーバー）

- 同時接続数: 〜100 WebSocket接続
- 同時ルーム数: 〜50ルーム
- メモリ使用量: 〜128MB

### 将来の拡張（必要に応じて）

- Redis Pub/Subによる複数サーバー間の状態同期
- ロードバランサーの導入
- CDNによる静的アセット配信
